name: lint dbt project on PR

on: [pull_request]

jobs:
  # this job runs SQLFluff with a specific set of rules
  lint_project:
    name: Run SQLFluff linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: "actions/checkout@v3"
        with:
          fetch-depth: 0
      - name: Set up Python
        uses: "actions/setup-python@v4"
        with:
          python-version: "3.11"

      - name: Install SQLFluff and dependencies
        run: |
          python -m pip install sqlfluff
          python -m pip install dbt-core dbt-snowflake

      - name: Create dummy private key
        run: |
          echo "-----BEGIN PRIVATE KEY-----" > /tmp/dummy_key.p8
          echo "dummy_key_content_for_linting" >> /tmp/dummy_key.p8
          echo "-----END PRIVATE KEY-----" >> /tmp/dummy_key.p8
          chmod 600 /tmp/dummy_key.p8

      - name: Setup environment variables for DBT
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT || 'dummy_account' }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER || 'dummy_user' }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE || 'PUBLIC' }}
          SNOWFLAKE_PRIVATE_KEY_PATH: /tmp/dummy_key.p8
          SNOWFLAKE_PRIVATE_KEY_PASSWORD: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSWORD || 'dummy_password' }}
          SNOWFLAKE_DATABASE_DEV: ${{ secrets.SNOWFLAKE_DATABASE_DEV || 'DUMMY_DB' }}
          SNOWFLAKE_DATABASE_PROD: ${{ secrets.SNOWFLAKE_DATABASE_PROD || 'DUMMY_DB_PROD' }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE || 'DUMMY_WH' }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA || 'PUBLIC' }}
          SNOWFLAKE_QUERY_TAG: ${{ secrets.SNOWFLAKE_QUERY_TAG || 'dbt_lint' }}
        run: |
          echo "üîç Configurando ambiente para SQLFluff..."

      - name: Lint SQL files with SQLFluff
        run: |
          echo "üîç Executando SQLFluff com regras do .sqlfluff..."

          # Lint todos os arquivos SQL no projeto
          sqlfluff lint dbt/ --dialect snowflake --templater dbt

          echo "‚úÖ SQLFluff executado com sucesso!"
